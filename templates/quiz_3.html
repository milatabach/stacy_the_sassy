<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Camera Quiz – Question 3</title>
  <link rel="stylesheet" href="/static/main.css" />
  <style>
    .img-container {
      position: relative;
      display: inline-block;
      overflow: hidden;
      border: 5px solid #333;
      border-radius: 10px;
    }
    #img-base, #img-sharp, #img-ghost1, #img-ghost2, #img-ghost3, #noiseOverlay {
      width: 400px;
      height: auto;
      border-radius: 10px;
    }
    #img-base { position: relative; z-index: 1; }
    #img-sharp {
      position: absolute; top: 0; left: 0;
      clip-path: circle(50% at 50% 50%);
      z-index: 2;
    }
    #img-ghost1, #img-ghost2, #img-ghost3 {
      position: absolute; top: 0; left: 0; z-index: 3;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }
    #noiseOverlay {
      position: absolute; top: 0; left: 0;
      mix-blend-mode: screen;
      pointer-events: none;
      z-index: 4;
    }
    .slider-container { max-width: 600px; margin: 20px auto; text-align: left; }
    .slider-container label { display: block; margin-bottom: 5px; }
    .slider-container input[type=range] { width: 100%; }
    .feedback { margin-top: 15px; font-weight: bold; }

    .next-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="bg-black text-white">
  <div class="container text-center py-4">
    <h1>Question 3</h1>
    <p>Stacy wants a slightly blurry pic to imitate the feeling of the wind blowing.</p>
    <div class="img-container">
      <img id="img-base" src="/static/images/Quiz_3.png" alt="base layer" />
      <img id="img-sharp" src="/static/images/Quiz_3.png" alt="sharp layer" />
      <img id="img-ghost1" src="/static/images/Quiz_3.png" alt="ghost layer 1" />
      <img id="img-ghost2" src="/static/images/Quiz_3.png" alt="ghost layer 2" />
      <img id="img-ghost3" src="/static/images/Quiz_3.png" alt="ghost layer 3" />
      <img id="noiseOverlay" src="/static/images/Noisy_long.png" alt="grain overlay" />
    </div>

    <div class="slider-container">
      <label for="aperture">Aperture (f-stop): <span id="ap-val"></span></label>
      <input type="range" id="aperture" min="1.8" max="22" step="0.1" value="1.8" />
      <label for="shutter">Shutter Speed (sec): <span id="sh-val"></span></label>
      <input type="range" id="shutter" min="0.001" max="2" step="0.001" value="0.001" />
      <label for="iso">ISO: <span id="iso-val"></span></label>
      <input type="range" id="iso" min="100" max="3200" step="100" value="100" />
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="mt-4">
      <button id="checkBtn" class="quiz-btn">Check Answer</button>
      <button id="nextBtn" class="next-btn disabled">Next Question→</button>
    </div>
  </div>

  <script>
    const MAX_TRIES = 3;
    let triesLeft = MAX_TRIES;
    let passed = false;

    const ap = document.getElementById('aperture');
    const sh = document.getElementById('shutter');
    const iso = document.getElementById('iso');
    const apVal = document.getElementById('ap-val');
    const shVal = document.getElementById('sh-val');
    const isoVal = document.getElementById('iso-val');
    const imgBase = document.getElementById('img-base');
    const sharp = document.getElementById('img-sharp');
    const ghosts = [
      document.getElementById('img-ghost1'),
      document.getElementById('img-ghost2'),
      document.getElementById('img-ghost3')
    ];
    const noise = document.getElementById('noiseOverlay');
    const feedback = document.getElementById('feedback');
    const checkBtn = document.getElementById('checkBtn');
    const nextBtn = document.getElementById('nextBtn');

    const correct = { aperture: 20.5, shutter: 1/19, iso: 2200 };
    const tol = { aperture: 0.4, shutter: 0.02, iso: 300 };

    function mapRange(x, inMin, inMax, outMin, outMax) {
      return outMin + ((x - inMin) * (outMax - outMin)) / (inMax - inMin);
    }

    function updateImage() {
      const A = parseFloat(ap.value);
      const S = parseFloat(sh.value);
      const I = parseFloat(iso.value);

      const blurPx = mapRange(A, 1.8, 22, 15, 0);
      imgBase.style.filter = `blur(${blurPx.toFixed(1)}px)`;
      const focusPct = mapRange(A, 1.8, 22, 20, 100);
      sharp.style.clipPath = `inset(0% 20% 30% 20% round 8px)`;
      apVal.textContent = A.toFixed(1);

      const threshold = 1/6;
      const baseMax = 30;
      const extMax = 60;
      let offset, opacity;
      if (S <= threshold) {
        offset = mapRange(S, 0.001, threshold, 0, baseMax);
        opacity = mapRange(S, 0.001, threshold, 0, 0.5);
      } else {
        offset = mapRange(S, threshold, 1, baseMax, extMax);
        opacity = mapRange(S, threshold, 1, 0.5, 0.8);
      }
      ghosts.forEach((g, i) => {
        g.style.transform = `translateX(-${(offset * (i + 1)) / ghosts.length}px)`;
        g.style.opacity = opacity;
      });
      shVal.textContent = `1/${Math.round(1/S)}`;

      const grainOp = mapRange(I, 100, 3200, 0.4, 0);
      noise.style.opacity = grainOp;
      isoVal.textContent = I;
    }

    function resetSliders() {
      ap.value = ap.min;
      sh.value = sh.min;
      iso.value = iso.min;
      updateImage();
    }

    checkBtn.addEventListener('click', () => {
      if (triesLeft < 1) return;

      const A = parseFloat(ap.value);
      const S = parseFloat(sh.value);
      const I = parseFloat(iso.value);
      const user = { aperture: A, shutter: S, iso: I };
      const allGood = Object.keys(correct).every(k => Math.abs(user[k] - correct[k]) <= tol[k]);

      if (allGood) {
        sessionStorage.setItem('quiz3', '1');
        feedback.textContent = '✅ Perfect!';
        feedback.style.color = 'lightgreen';
        passed = true;
        checkBtn.disabled = true;
        nextBtn.classList.remove('disabled');
      } else {
        triesLeft--;
        if (triesLeft > 0) {
          feedback.textContent = `❌ Almost—${triesLeft} tries left.`;
          feedback.style.color = '#ffcc00';
          resetSliders();
        } else {
          sessionStorage.setItem('quiz3', '0');
          feedback.textContent = '⚠️ Out of tries—moving on.';
          feedback.style.color = '#ff4d4d';
          passed = true;
          checkBtn.disabled = true;
          nextBtn.classList.remove('disabled');
        }
      }
    });

    nextBtn.addEventListener('click', function(event) {
      if (!passed) {
        event.preventDefault();
        feedback.textContent = '⚠️ You must pass this question before continuing.';
        feedback.style.color = '#ff4d4d';
      } else {
        window.location.href = '/quiz/4';
      }
    });

    [ap, sh, iso].forEach(el => el.addEventListener('input', updateImage));

    document.addEventListener('DOMContentLoaded', () => {
      resetSliders();
      passed = false;
      nextBtn.classList.add('disabled');
    });
  </script>
</body>
</html>
